<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>White Mirror 白鏡美甲 - 預約系統</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons for aesthetic visual elements -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e5e7eb; /* Cool Grey 200 - Darker background for depth */
        }
        .ins-card {
            background-color: #ffffff;
            border-radius: 1.2rem; /* Slightly softer corners for depth */
            /* Multi-layered, deeper shadow for a floating, substantial panel look */
            box-shadow: 
                0 25px 50px -12px rgba(0, 0, 0, 0.25), /* Deep ambient shadow */
                0 0 0 1px rgba(0, 0, 0, 0.05); /* Thin subtle border for definition */
            border: 1px solid #f3f4f6; /* Subtle light border for highlight */
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        /* Updated button style for Silver/Grey Mirror theme - Enhanced Depth */
        .grey-button { 
            background-color: #d1d5db; /* Cool Grey 300 */
            color: #1f2937; /* Dark Slate text */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), inset 0 2px 4px 0 rgba(0, 0, 0, 0.06); /* Inner shadow for clickable depth */
            border-bottom: 3px solid #9ca3af; /* Stronger bottom border for push effect */
            transition: background-color 0.2s ease, transform 0.1s ease, border-bottom 0.1s ease;
        }
        .grey-button:hover:not(:disabled) {
            background-color: #9ca3af; /* Cooler hover state */
            transform: translateY(1px); /* Push down effect */
            border-bottom: 1px solid #9ca3af;
        }
        .grey-button:disabled {
            background-color: #f3f4f6;
            color: #9ca3af;
            cursor: not-allowed;
            box-shadow: none;
            border-bottom: 3px solid #e5e7eb;
        }
        /* Updated accent color for Deep Slate/Silver */
        .gold-accent {
            color: #374151; /* Deeper Slate Grey for prominence */
            font-weight: 700; /* Bold accent text */
        }
        /* Style for selected date - Stronger contrast */
        .date-selected {
            background-color: #4b5563; /* Deep Slate for selection */
            color: white;
            box-shadow: 0 6px 10px -2px rgba(0, 0, 0, 0.3); /* Stronger selection lift */
            border: 2px solid #374151;
        }
        .date-available {
             border: 2px solid #e5e7eb; /* Light silver border */
             box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        /* Style for the price table header to match the grey theme */
        .price-table-header {
            background-color: #f3f4f6; /* Cool Grey 100 */
            border-radius: 1.2rem 1.2rem 0 0;
            padding: 3rem 1.5rem;
            text-align: center;
        }

        /* --- Custom CSS for Irregular Lines Background (Simulating Brushed Metal) --- */
        .irregular-lines {
            background-color: #e5e7eb; /* Base cool grey */
            position: relative;
            /* Using SVG Data URL to simulate a subtle, irregular BRUSHED METAL texture */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100%25' height='100%25' viewBox='0 0 100 100'%3E%3Cpath fill='none' stroke='%239ca3af' stroke-width='0.8' d='M0 50 C 25 25, 50 75, 75 50 S 100 25, 100 50'/%3E%3Cpath fill='none' stroke='%239ca3af' stroke-width='0.8' d='M0 75 C 20 90, 80 10, 100 25'/%3E%3Cpath fill='none' stroke='%239ca3af' stroke-width='0.8' d='M0 25 C 20 10, 80 90, 100 75'/%3E%3C/svg%3E");
            background-size: 100% 100%;
            background-repeat: no-repeat;
            opacity: 0.8;
            border-bottom: 2px solid #d1d5db; /* Stronger separation line */
        }

        /* Styling for the Hand Model radio group */
        .radio-scroll-container {
            display: flex;
            overflow-x: auto;
            border: 1px solid #9ca3af; /* Stronger border for rich look */
            border-radius: 0.75rem;
            background-color: #f5f5f5;
        }
        .radio-scroll-item {
            flex: 1 0 auto;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            text-align: center;
            border-right: 1px solid #d1d5db;
        }
        .radio-scroll-item:last-child {
            border-right: none;
        }
        .radio-scroll-item input {
            display: none;
        }
        .radio-scroll-item input:checked + span {
            background-color: #4b5563; /* Deep Slate accent for selected */
            color: white;
            font-weight: bold;
            border-radius: 0.6rem;
            display: block;
            margin: -0.75rem -1.5rem;
            padding: 0.75rem 1.5rem;
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.4); /* Inner shine effect */
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex justify-center items-start">

    <div id="app" class="w-full max-w-4xl ins-card p-6 md:p-10">

        <!-- Header/Title Section - Enhanced Visual Weight -->
        <header class="text-center mb-10 border-b pb-4 border-stone-200">
            <div class="flex items-center justify-center mb-4">
                 <i data-lucide="gem" class="w-8 h-8 mr-3 gold-accent"></i>
                 <h1 class="text-5xl font-extralight gold-accent tracking-widest">White mirror</h1>
            </div>
            <h2 class="text-2xl font-bold text-stone-700">白鏡美甲 預約服務</h2>
            <p class="text-sm text-stone-500 mt-2">冷靜、高級、極致簡約的美甲藝術。請選擇您的專屬時光。</p>
        </header>

        <!-- Main Booking Interface -->
        <div id="booking-interface" class="space-y-10">
            
            <!-- Important Policies Section -->
            <div class="pt-4 space-y-8">
                <h3 class="text-2xl font-bold gold-accent text-center">--- 白鏡美甲 重要須知 ---</h3>

                <!-- 預約須知 -->
                <div class="p-6 ins-card border-l-4 border-gold-accent shadow-sm">
                    <h4 class="text-xl font-semibold text-stone-700 mb-4 flex items-center">
                        <i data-lucide="file-text" class="w-5 h-5 mr-2 gold-accent"></i>預約須知 (Booking Policy)
                    </h4>
                    <ul class="text-stone-600 space-y-2 list-disc list-inside text-sm">
                        <!-- CRITICAL POLICY -->
                        <li class="p-2 bg-red-100 border border-red-300 rounded-lg shadow-inner">
                            <span class="font-bold text-red-700">!! 新手美甲師特點 - 務必久坐 !!</span><br>
                            本次服務由新手美甲師施作，請務必空出 4-5 小時，確保有足夠時間完成服務。此為最重要的注意事項！
                        </li>
                        <li>**預約時間：** 目前僅開放每週一、三、四的 12:00, 15:00, 18:00 三個時段。</li>
                        <li>**時段保留：** 成功送出預約後，請務必於 12 小時內透過官方 LINE (@702nkzdn) 聯繫確認細節，否則系統將自動取消預約。</li>
                        <li>
                            **遲到取消：** 遲到超過 <span class="font-bold text-red-500">10 分鐘</span>者，視同自動取消。
                        </li>
                        <li>
                            **改期規定：** 如需改期，請提前 <span class="font-bold text-red-500">3 天 (72 小時)</span> 告知。
                        </li>
                        <li>
                            **重複違規定金政策：** <span class="font-bold text-red-500">若有兩次以上遲到/未提前改期記錄者，下次預約須先支付 $500 定金。</span>
                        </li>
                        <li>**攜伴規定：** 為了提供更舒適的服務空間，請勿攜帶寵物或未預約的親友陪同。</li>
                    </ul>
                </div>

                <!-- 美甲注意事項 -->
                <div class="p-6 ins-card border-l-4 border-gold-accent shadow-sm">
                    <h4 class="text-xl font-semibold text-stone-700 mb-4 flex items-center">
                        <i data-lucide="hand-metal" class="w-5 h-5 mr-2 gold-accent"></i>美甲注意事項 (Nail Care Precautions)
                    </h4>
                    <ul class="text-stone-600 space-y-2 list-disc list-inside text-sm">
                        <li>**清潔保養：** 美甲後 24 小時內應避免長時間接觸熱水或清潔劑。</li>
                        <li>
                            **日常習慣：** <span class="font-bold text-red-500">請盡量避免用指尖做事</span>，建議使用指腹或工具。
                        </li>
                        <li>
                            **7天售後保固：** 若施作後 <span class="font-bold text-red-500">7 天內</span> 非人為因素造成美甲瑕疵，可免費補受損的指甲。
                        </li>
                        <li>**指甲油/凝膠維護：** 請勿自行摳剝凝膠，若有嚴重破損請儘速回店修補。</li>
                        <li>**基礎護理：** 平日可塗抹指緣油或護手霜加強保濕。</li>
                        <li>**過敏反應：** 若有任何皮膚過敏或不適，請立即停止使用。</li>
                    </ul>
                </div>
            </div>
            <!-- End Important Policies Section -->

            <!-- Price List Section -->
            <div class="pt-8 border-t border-stone-300">
                <h3 class="text-2xl font-bold gold-accent text-center mb-6">--- 服務價目表 ---</h3>
                
                <div class="ins-card p-0 overflow-hidden">
                    <!-- Price Table Header with Irregular Lines (Brushed Metal Effect) -->
                    <div class="price-table-header irregular-lines">
                        <p class="text-3xl font-light text-stone-700 tracking-widest mb-1">WHITE MIRROR Nail</p>
                        <p class="text-lg text-stone-500 font-medium">價目表</p>
                    </div>

                    <div class="p-6 md:p-8">
                        <!-- Text Price List -->
                        <table class="min-w-full divide-y divide-stone-300">
                            <thead class="bg-stone-100">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-bold text-stone-700 uppercase tracking-wider">項目</th>
                                    <th class="px-3 py-3 text-right text-xs font-bold text-stone-700 uppercase tracking-wider">價格</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-stone-200 text-stone-700">
                                <tr>
                                    <td class="px-3 py-3 font-medium">手部保養 - 甘皮、修型</td>
                                    <td class="px-3 py-3 text-right text-gold-accent font-bold">$250</td>
                                </tr>
                                <tr>
                                    <td class="px-3 py-3 font-medium">單色</td>
                                    <td class="px-3 py-3 text-right text-gold-accent font-bold">$499</td>
                                </tr>
                                <tr>
                                    <td class="px-3 py-3 font-medium">跳色 (2色或以上)</td>
                                    <td class="px-3 py-3 text-right text-gold-accent font-bold">$599</td>
                                </tr>
                                <tr>
                                    <td class="px-3 py-3 font-medium">貓眼</td>
                                    <td class="px-3 py-3 text-right text-gold-accent font-bold">$899</td>
                                </tr>
                                <tr>
                                    <td class="px-3 py-3 font-medium">造型 - 複雜程度另計</td>
                                    <td class="px-3 py-3 text-right text-gold-accent font-bold">$999 up</td>
                                </tr>
                                <tr>
                                    <td class="px-3 py-3 font-medium">延甲 (1指)</td>
                                    <td class="px-3 py-3 text-right text-gold-accent font-bold">$100</td>
                                </tr>
                                <tr>
                                    <td class="px-3 py-3 font-medium">十指全延</td>
                                    <td class="px-3 py-3 text-right text-gold-accent font-bold">$800</td>
                                </tr>
                                <tr>
                                    <td class="px-3 py-3 font-medium">本店卸甲 (續作/單卸)</td>
                                    <td class="px-3 py-3 text-right text-gold-accent font-bold">$200 / $250</td>
                                </tr>
                                <tr>
                                    <td class="px-3 py-3 font-medium">它店卸甲 (續作/單卸)</td>
                                    <td class="px-3 py-3 text-right text-gold-accent font-bold">$400 / $450</td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- Price List Notes and Discounts -->
                        <div class="mt-6 p-4 bg-stone-100 rounded-lg space-y-3 text-sm text-stone-600 border border-stone-300 shadow-inner">
                            <p class="font-bold text-stone-800">費用說明與注意事項：</p>
                            <ul class="list-disc list-inside space-y-1">
                                <li>所有凝膠美甲價格皆<span class="font-semibold text-gold-accent">含基礎保養、建構加厚</span>。</li>
                                <li>本店/它店作品皆<span class="font-semibold text-red-600">無法 100% 複製</span>。</li>
                            </ul>
                        </div>

                    </div>
                </div>
            </div>
            <!-- End Price List Section -->

            <!-- Step 1: Date Selection -->
            <div class="pt-8 border-t border-stone-300">
                <h3 class="text-xl font-semibold text-stone-700 mb-4 border-b pb-2"><i data-lucide="calendar" class="w-5 h-5 inline mr-2 gold-accent"></i>1. 選擇日期 (週一、三、四)</h3>
                <div id="calendar-view" class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-7 gap-3 max-h-80 overflow-y-auto pr-2">
                    <!-- Dates will be populated here by JavaScript -->
                    <div class="text-center p-4 bg-stone-100 rounded-xl text-stone-500">載入中...</div>
                </div>
            </div>

            <!-- Step 2: Time Slot Selection -->
            <div id="time-selection-container" class="opacity-50 pointer-events-none">
                <h3 class="text-xl font-semibold text-stone-700 mb-4 border-b pb-2"><i data-lucide="clock" class="w-5 h-5 inline mr-2 gold-accent"></i>2. 選擇時段 (<span id="selected-date-display" class="gold-accent">請先選擇日期</span>)</h3>
                <div id="time-slots-view" class="grid grid-cols-3 sm:grid-cols-6 gap-4">
                    <!-- Time slots will be populated here -->
                </div>
            </div>

            <!-- Step 3: Confirmation and Form -->
            <div id="confirmation-container" class="opacity-50 pointer-events-none">
                <h3 class="text-xl font-semibold text-stone-700 mb-4 border-b pb-2"><i data-lucide="user-check" class="w-5 h-5 inline mr-2 gold-accent"></i>3. 填寫資料並確認預約</h3>
                <div id="slot-summary" class="p-4 bg-red-100 text-red-700 rounded-xl mb-4 font-medium shadow-inner">請選擇日期與時段</div>

                <form id="booking-form" class="space-y-4">
                    
                    <!-- Service Selection -->
                    <div>
                        <label for="service" class="block text-sm font-medium text-stone-700 mb-1 flex items-center">
                            <i data-lucide="paintbrush" class="w-4 h-4 mr-2 gold-accent"></i> 預約服務項目 (必選)
                        </label>
                        <select id="service" required class="mt-1 block w-full px-4 py-2 border border-stone-400 rounded-lg shadow-inner focus:ring-gold-accent focus:border-gold-accent transition duration-150">
                            <option value="" disabled selected>請選擇您需要的服務</option>
                            <option value="單色">單色 ($499)</option>
                            <option value="跳色">跳色 ($599)</option>
                            <option value="貓眼">貓眼 ($899)</option>
                            <option value="造型">造型 ($999 up) - (手模不可選)</option>
                            <option value="手部保養">手部保養 ($250) - (手模不可選)</option>
                            <option value="十指全延">十指全延 ($800)</option>
                            <option value="卸甲-本店續作">本店卸甲 (續作)</option>
                            <option value="卸甲-本店單卸">本店卸甲 (單卸)</option>
                            <option value="卸甲-它店續作">它店卸甲 (續作)</option>
                            <option value="卸甲-它店單卸">它店卸甲 (單卸)</option>
                        </select>
                    </div>

                    <!-- Hand Model Status -->
                    <div>
                        <label class="block text-sm font-medium text-stone-700 mb-1 flex items-center">
                            <i data-lucide="hand" class="w-4 h-4 mr-2 gold-accent"></i> 是否為手模 (請根據約定選擇)
                        </label>
                        <div class="radio-scroll-container">
                            <label class="radio-scroll-item">
                                <input type="radio" name="isHandModel" value="no" required checked>
                                <span>否 (一般顧客)</span>
                            </label>
                            <label class="radio-scroll-item">
                                <input type="radio" name="isHandModel" value="yes" required>
                                <span>是 (手模，服務受限)</span>
                            </label>
                        </div>
                        <p id="model-restriction-tip" class="text-xs text-red-500 mt-1 hidden">
                            手模限定項目：單色、跳色、貓眼、十指全延、它店卸甲（續作/單卸）。
                        </p>
                    </div>

                    <div>
                        <label for="name" class="block text-sm font-medium text-stone-700">您的姓名 (必填)</label>
                        <input type="text" id="name" required class="mt-1 block w-full px-4 py-2 border border-stone-400 rounded-lg shadow-inner focus:ring-gold-accent focus:border-gold-accent transition duration-150">
                    </div>
                    <div>
                        <label for="lineId" class="block text-sm font-medium text-stone-700">您的 LINE ID (必填，用於聯繫)</label>
                        <input type="text" id="lineId" required class="mt-1 block w-full px-4 py-2 border border-stone-400 rounded-lg shadow-inner focus:ring-gold-accent focus:border-gold-accent transition duration-150">
                    </div>
                    
                    <!-- NEW: Contact Phone Number Field (必填) -->
                    <div>
                        <label for="phone" class="block text-sm font-medium text-stone-700">聯絡電話 (必填)</label>
                        <input type="tel" id="phone" required class="mt-1 block w-full px-4 py-2 border border-stone-400 rounded-lg shadow-inner focus:ring-gold-accent focus:border-gold-accent transition duration-150" placeholder="例如: 0912-345-678">
                    </div>
                    
                    <button type="submit" id="submit-booking-btn" class="w-full py-3 grey-button rounded-xl font-bold text-lg hover:shadow-lg" disabled>
                        確認預約此時段
                    </button>
                    <p id="error-message" class="text-sm text-red-600 mt-2 hidden"></p>
                </form>
            </div>
            

        </div>

        <!-- Footer/Contact Links Section (Instagram and LINE) -->
        <footer class="mt-10 pt-8 border-t border-stone-300 text-center">
            <h3 class="text-xl font-bold text-stone-700 mb-6">聯繫我們 / 查看更多作品</h3>
            <div class="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4">
                
                <!-- Instagram Link -->
                <a href="https://www.instagram.com/white.mirror_nail?igsh=MW5qb2g1ajNzamhsNQ%3D%3D&utm_source=qr" target="_blank" class="py-3 px-8 grey-button rounded-xl font-bold flex items-center justify-center hover:border-b-1 border-stone-300">
                    <i data-lucide="instagram" class="w-5 h-5 mr-2"></i>
                    作品集 IG 連動
                </a>

                <!-- LINE Contact Link (@702nkzdn) - Enhanced style for main action -->
                <a href="https://line.me/R/ti/p/@702nkzdn" target="_blank" class="py-3 px-8 rounded-xl font-bold flex items-center justify-center bg-gray-700 text-white hover:bg-gray-800 transition duration-150 shadow-lg border-b-4 border-gray-900">
                    <i data-lucide="message-circle" class="w-5 h-5 mr-2"></i>
                    官方 LINE 聯繫 (@702nkzdn)
                </a>
            </div>
            <p class="text-xs text-stone-400 mt-6">© 2024 White Mirror Nail. All rights reserved.</p>
        </footer>


        <!-- Success/Modal Message Box (Custom implementation to replace alert()) -->
        <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center hidden">
            <div id="modal-content" class="ins-card p-8 w-11/12 max-w-md text-center">
                <h4 id="modal-title" class="text-2xl font-bold gold-accent mb-4"></h4>
                <p id="modal-body" class="text-stone-700 mb-6"></p>
                <button onclick="closeModal()" class="py-2 px-6 grey-button rounded-xl font-semibold">關閉</button>
            </div>
        </div>

    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, where, Timestamp, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Replace Lucide icons after DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
        });


        // Firestore logging for debugging
        setLogLevel('Debug');

        // --- GLOBAL VARIABLES (Provided by Canvas Environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // --- STATE MANAGEMENT ---
        let selectedDate = null; // Format: YYYY-MM-DD
        let selectedTime = null; // Format: HH:MM
        let appointments = []; // Array of {date, time} objects from Firestore

        const APPOINTMENT_TIMES = ['12:00', '15:00', '18:00'];
        const AVAILABLE_DAYS = [1, 3, 4]; // 0=Sun, 1=Mon, 2=Tue, 3=Wed, 4=Thu, 5=Fri, 6=Sat

        // --- UI ELEMENTS ---
        const calendarView = document.getElementById('calendar-view');
        const timeSlotsView = document.getElementById('time-slots-view');
        const selectedDateDisplay = document.getElementById('selected-date-display');
        const timeContainer = document.getElementById('time-selection-container');
        const confirmationContainer = document.getElementById('confirmation-container');
        const slotSummary = document.getElementById('slot-summary');
        const bookingForm = document.getElementById('booking-form');
        const submitBtn = document.getElementById('submit-booking-btn');
        const errorMessage = document.getElementById('error-message');
        const modelRestrictionTip = document.getElementById('model-restriction-tip');
        const serviceSelect = document.getElementById('service');
        const isHandModelRadios = document.querySelectorAll('input[name="isHandModel"]');
        
        // Hand model restricted services (allowed services for hand models)
        const HAND_MODEL_ALLOWED_SERVICES = ['單色', '跳色', '貓眼', '十指全延', '卸甲-它店續作', '卸甲-它店單卸'];


        // --- UTILITY FUNCTIONS ---

        /**
         * Shows the custom modal/message box.
         * @param {string} title - The modal title.
         * @param {string} body - The modal body text.
         */
        window.showModal = function(title, body) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').textContent = body;
            document.getElementById('modal-container').classList.remove('hidden');
            document.getElementById('modal-container').classList.add('flex');
        }

        /**
         * Closes the custom modal/message box.
         */
        window.closeModal = function() {
            document.getElementById('modal-container').classList.remove('flex');
            document.getElementById('modal-container').classList.add('hidden');
            // Reload the page to reset the form state cleanly after success
            if (document.getElementById('modal-title').textContent.includes('成功')) {
                window.location.reload();
            }
        }

        /**
         * Generates and renders the available booking dates (Mon, Wed, Thu) for the next 4 weeks.
         */
        function renderCalendar() {
            calendarView.innerHTML = '<div class="text-center p-4 col-span-full text-stone-500">載入日期中...</div>';
            const dates = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize time to midnight

            // Generate dates for the next 4 weeks (max 28 days)
            for (let i = 0; i < 28; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                
                const dayOfWeek = date.getDay(); // 0 (Sun) to 6 (Sat)

                if (AVAILABLE_DAYS.includes(dayOfWeek)) {
                    dates.push(date);
                }
            }

            // Render the buttons
            calendarView.innerHTML = '';
            dates.forEach(date => {
                const dateString = date.toISOString().split('T')[0]; // YYYY-MM-DD
                const dayName = ['日', '一', '二', '三', '四', '五', '六'][date.getDay()];
                const isSelected = dateString === selectedDate;
                
                const dateBtn = document.createElement('button');
                dateBtn.setAttribute('data-date', dateString);
                dateBtn.className = `p-3 flex flex-col items-center justify-center rounded-xl font-semibold text-sm ${isSelected ? 'date-selected' : 'bg-white text-stone-700 hover:bg-stone-100 date-available'}`;

                dateBtn.innerHTML = `
                    <span class="text-xs text-stone-500 ${isSelected ? 'text-white' : ''}">週${dayName}</span>
                    <span class="text-xl">${date.getDate()}</span>
                    <span class="text-xs">${date.getMonth() + 1}月</span>
                `;

                dateBtn.addEventListener('click', () => handleDateSelection(dateString));
                calendarView.appendChild(dateBtn);
            });
        }

        /**
         * Handles date selection, updates state, and renders time slots.
         * @param {string} dateString - Selected date (YYYY-MM-DD).
         */
        function handleDateSelection(dateString) {
            // Update state and UI
            selectedDate = dateString;
            selectedTime = null; // Reset time selection
            renderCalendar();
            renderTimeSlots();

            // Update display text
            const dateParts = dateString.split('-');
            selectedDateDisplay.textContent = `${dateParts[1]}月${dateParts[2]}日`;

            // Enable time selection step
            timeContainer.classList.remove('opacity-50', 'pointer-events-none');
            // Disable confirmation step until time is picked
            confirmationContainer.classList.add('opacity-50', 'pointer-events-none');
            slotSummary.innerHTML = '請選擇時段';
            submitBtn.disabled = true;
            errorMessage.classList.add('hidden');
        }

        /**
         * Renders the time slots for the currently selected date, marking taken slots.
         */
        function renderTimeSlots() {
            timeSlotsView.innerHTML = '';
            if (!selectedDate) return;

            APPOINTMENT_TIMES.forEach(time => {
                const isBooked = appointments.some(app => app.date === selectedDate && app.time === time);
                const isSelected = selectedTime === time;

                const timeBtn = document.createElement('button');
                timeBtn.setAttribute('data-time', time);
                timeBtn.disabled = isBooked;

                let classes = 'p-3 rounded-xl font-bold transition duration-150';

                if (isBooked) {
                    classes += ' bg-red-100 text-red-500 line-through cursor-not-allowed';
                    timeBtn.innerHTML = `${time} (已預約)`;
                } else if (isSelected) {
                    // Selection style with inner shine
                    classes += ' bg-gray-600 text-white shadow-lg border-b-4 border-gray-900 shadow-inner'; 
                    timeBtn.innerHTML = `${time} (已選)`;
                } else {
                    // Regular grey button with depth
                    classes += ' bg-white text-stone-700 grey-button hover:shadow-md';
                    timeBtn.innerHTML = time;
                }

                timeBtn.className = classes;

                if (!isBooked) {
                    timeBtn.addEventListener('click', () => handleTimeSelection(time));
                }
                timeSlotsView.appendChild(timeBtn);
            });
        }

        /**
         * Handles time selection, updates state, and enables the confirmation form.
         * @param {string} time - Selected time (HH:MM).
         */
        function handleTimeSelection(time) {
            selectedTime = time;
            renderTimeSlots(); // Re-render to highlight selection

            // Enable confirmation step
            confirmationContainer.classList.remove('opacity-50', 'pointer-events-none');
            
            // Check if service and name/lineId/phone are filled to enable submit button
            checkFormValidity();
            
            const dateParts = selectedDate.split('-');
            slotSummary.innerHTML = `<span class="font-bold gold-accent">您已選擇:</span> ${dateParts[1]}月${dateParts[2]}日, ${selectedTime}`;
            slotSummary.classList.remove('bg-red-100', 'text-red-700');
            slotSummary.classList.add('bg-stone-100', 'text-stone-700');
            errorMessage.classList.add('hidden');
        }

        /**
         * Checks the validity of the form fields (required fields) and updates the submit button state.
         * Also performs the hand model restriction check.
         */
        function checkFormValidity() {
            // 檢查所有必填欄位 (包括新增的電話欄位)
            const isTimeSelected = selectedTime !== null;
            const isServiceSelected = serviceSelect.value !== "";
            const isNameFilled = document.getElementById('name').value.trim() !== "";
            const isLineIdFilled = document.getElementById('lineId').value.trim() !== "";
            const isPhoneFilled = document.getElementById('phone').value.trim() !== ""; // 檢查電話
            
            // 總體表單有效性
            let isFormValid = isTimeSelected && isServiceSelected && isNameFilled && isLineIdFilled && isPhoneFilled; 
            let handModelRestrictionMet = true;
            
            // 手模限制檢查
            const isHandModel = document.querySelector('input[name="isHandModel"]:checked').value === 'yes';
            const selectedService = serviceSelect.value;

            if (isHandModel) {
                // Check if the selected service is in the allowed list for hand models
                if (!HAND_MODEL_ALLOWED_SERVICES.includes(selectedService)) {
                    handModelRestrictionMet = false;
                    modelRestrictionTip.classList.remove('hidden');
                } else {
                    modelRestrictionTip.classList.add('hidden');
                }
            } else {
                modelRestrictionTip.classList.add('hidden');
            }
            
            // The submit button is only enabled if all required fields are filled AND restrictions are met.
            submitBtn.disabled = !(isFormValid && handModelRestrictionMet);
        }

        // Add event listeners for form validation on input/change
        serviceSelect.addEventListener('change', checkFormValidity);
        document.getElementById('name').addEventListener('input', checkFormValidity);
        document.getElementById('lineId').addEventListener('input', checkFormValidity);
        document.getElementById('phone').addEventListener('input', checkFormValidity); // 電話欄位事件監聽
        isHandModelRadios.forEach(radio => radio.addEventListener('change', checkFormValidity));


        /**
         * Submits the booking data to Firestore.
         */
        async function submitBooking(event) {
            event.preventDefault();
            
            checkFormValidity(); // Final check before submission
            if (submitBtn.disabled) {
                errorMessage.textContent = '請檢查所有欄位及手模服務限制是否符合規定。';
                errorMessage.classList.remove('hidden');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = '預約中...';

            const name = document.getElementById('name').value.trim();
            const lineId = document.getElementById('lineId').value.trim();
            const phone = document.getElementById('phone').value.trim(); // 獲取聯絡電話
            const selectedService = serviceSelect.value;
            const isHandModel = document.querySelector('input[name="isHandModel"]:checked').value === 'yes';

            const appointmentData = {
                date: selectedDate,
                time: selectedTime,
                service: selectedService, 
                isHandModel: isHandModel, 
                name: name,
                lineId: lineId,
                phone: phone, // 存儲聯絡電話
                userId: userId, 
                timestamp: Timestamp.now()
            };

            // Check if the slot is still available (re-check to prevent race condition)
            const isBooked = appointments.some(app => app.date === selectedDate && app.time === selectedTime);
            if (isBooked) {
                showModal('預約失敗', '您選擇的時段剛好被預約走了，請重新選擇其他時段。');
                submitBtn.disabled = false;
                submitBtn.textContent = '確認預約此時段';
                return;
            }

            try {
                // Using date + time as part of the document ID to ensure uniqueness for the time slot
                const docId = `${selectedDate}_${selectedTime}`;
                const collectionRef = collection(db, `/artifacts/${appId}/public/data/nail_appointments`);
                
                // Use setDoc to create/overwrite the document with the unique ID
                await setDoc(doc(collectionRef, docId), appointmentData);

                showModal(
                    '預約成功!',
                    `恭喜您，已成功預約 ${selectedDateDisplay.textContent} ${selectedTime} 的美甲服務。\n\n您選擇的服務為：${selectedService} (手模: ${isHandModel ? '是' : '否'})。\n\n我們已記錄您的預約，請點擊下方的 LINE 按鈕 (或搜尋 @702nkzdn) 聯繫我們確認細節，完成最後確認！`
                );

            } catch (error) {
                console.error("Error submitting appointment: ", error);
                showModal('預約失敗', `發生錯誤，請稍後再試。錯誤訊息: ${error.message}`);
                errorMessage.textContent = `預約提交失敗: ${error.message}`;
                errorMessage.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '確認預約此時段';
            }
        }

        // --- FIREBASE AND INITIALIZATION ---

        /**
         * Starts listening for real-time appointment changes.
         */
        function startAppointmentListener() {
            if (!db || !isAuthReady) {
                console.log("Firestore or Auth not ready, skipping listener setup.");
                return;
            }
            
            // Reference the public collection path
            const collectionPath = `/artifacts/${appId}/public/data/nail_appointments`;
            const appointmentsRef = collection(db, collectionPath);
            
            // Query: We'll filter in-memory for simplicity as the total appointment count is small.
            const q = query(appointmentsRef); 

            onSnapshot(q, (snapshot) => {
                const newAppointments = [];
                snapshot.forEach((doc) => {
                    newAppointments.push(doc.data());
                });
                
                appointments = newAppointments;
                console.log("Appointments updated:", appointments);
                
                // Re-render UI components to reflect new booked slots
                renderCalendar();
                renderTimeSlots();
            }, (error) => {
                console.error("Error listening to appointments: ", error);
            });
        }

        /**
         * Initializes Firebase and handles authentication.
         */
        async function initializeAppAndAuth() {
            if (!firebaseConfig) {
                console.error("Firebase config is missing.");
                showModal('系統錯誤', '無法載入 Firebase 配置，預約功能暫時無法使用。');
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Try to sign in with custom token first
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Fallback to anonymous sign-in if no custom token
                    await signInAnonymously(auth);
                }

                // Set up auth state change listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Authenticated User ID:", userId);
                    } else {
                        // This should not happen if signInAnonymously is successful, but good practice
                        userId = crypto.randomUUID(); // Fallback ID if necessary
                        console.log("User signed out, using fallback ID:", userId);
                    }
                    isAuthReady = true;
                    // Start Firestore listener once auth is ready
                    startAppointmentListener();
                    renderCalendar(); // Initial render
                });

                // Attach form listener
                bookingForm.addEventListener('submit', submitBooking);

            } catch (error) {
                console.error("Firebase Initialization or Auth Error: ", error);
                showModal('認證錯誤', `無法連接到預約服務。錯誤: ${error.message}`);
            }
        }

        // --- START APPLICATION ---
        initializeAppAndAuth();
        
        // Initial call to render calendar frame while waiting for auth
        renderCalendar(); 
    </script>
</body>
</html>

